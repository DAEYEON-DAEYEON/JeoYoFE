{% extends 'common/base.html' %}

{% block title %}{% endblock %}

{% block extra_css %}
{% load humanize %}
<link rel="stylesheet" href="/static/css/login.css">
<!-- <link rel="stylesheet" href="/static/css/proser/create.css"> -->
<link rel="stylesheet" href="/static/css/proser/detail.css">
{% endblock %}


{% block content %}

    <div id="explanation" class="contents main_contents">
        <!-- íŒì—… -->
        <div id="popup" class="popup-overlay">
            <div class="popup-content">
                <span class="close-btn">&times;</span>
                <form onSubmit="return goprice(this);" enctype="multipart/form-data">
                    <!-- ì„œë¹„ìŠ¤ì•„ì´ë””ë¡œ ë°”ê¾¸ê¸° -->
                    <input type="hidden" name="sid" value="{{ sid }}">
                    <!-- ìœ ì €ëª…ìœ¼ë¡œ ë°”ê¾¸ê¸° -->
                    <input type="hidden" name="offeruserid" value={{ request.session.id }}>
                    <h2 style="text-align: left;">ê°€ê²© ì œì‹œ</h2>
                    <p style="text-align: left;"></p>
                    <div>
                        <p style="margin: 0; text-align: left; color: black;">ì›í•˜ì‹œëŠ” ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                        <input class="input-price" type="number" name="maxval">
                        <p style="margin: 0; text-align: left; color: black;">ê¸°íƒ€ì‚¬í•­ì´ ìˆìœ¼ì‹œë‹¤ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <input class="input-price" type="text" name="des">
                    </div>
                    <button id="go-price" class="custom-btn btn-4"><span>ê°€ê²© ì œì‹œ</span></button>
                </form>   
            </div>
        </div>
        <!-- íŒì—…ë -->
        
        <!-- ì œí’ˆ ì„¤ëª… -->
        <div class="exp-box" id="pro">
            <div class="exp-content img_wrap" id="img_wrap">
                <img id="imgon" src="https://g-oss-jeoyo-qrxlf.run.goorm.site/media/{{ img }}">
            </div>
            <div class="exp-content info_box">
                <div class="exp-text">
                    <h3>{{ name }}</h3>
                    <div class="inner-box">
                        <div>
                            <p class="right">{{ date }}</p>
                            <p class="right">{{ uid }}</p>
                        </div>

                        <div class="des"><p class="black">{{ des }}</p></div>
                        
                        <div>
                            {% if auctions %}
                            <label name="maxval">í˜„ì¬ ìµœê³ ê°€</label>
                            {% else %}
                            <label name="maxval">ìµœì†Œ ì œì‹œ ê¸ˆì•¡</label>
                            {% endif %}
                            <p style="color:#428BF9; font-weight:900;">{{maxval | intcomma}}</p>
                        </div>
    

                        <div class="btn-box">
                            {% if serviceend == True %}
                            <button class="custom-btn btn-4"><span style="color:#0046f3b3; font-weight: 600;">ì…ì°° ì¢…ë£Œ</span></button>
                            {% elif request.session.id and request.session.id == uid %}
                            	{% if usecredit == 0 %}
                            <button id="use-credit" class="custom-btn btn-4"><span>í¬ë ˆë”§ ì‚¬ìš©</span></button>
                            	{% endif %}
                                {% if auctions %}
                            <button id="finish" class="custom-btn btn-4"><span style="color: #004e54d6; font-weight: 600;">ë‚™ì°°</span></button>
                                {% else %}
                            <button id="nofinish" class="custom-btn btn-4"><span style="color: #004e54d6; font-weight: 600;">ë‚™ì°°</span></button>
                                {% endif %}
                            <!-- ì‘ì„±ìë‘ ì´ë¦„ì´ ë‹¤ë¥¸ ê²½ìš° -->
                            {% elif request.session.id %}
                            <button id="price-btn" class="custom-btn btn-4"><span>ê¸ˆì•¡ ì œì‹œ</span></button>
                            {% else %}
                            <button id="gologin" class="custom-btn btn-4"><span>ê¸ˆì•¡ ì œì‹œ</span></button>
                            {% endif %}
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        
        <!-- ì œì‹œí•œ ì‚¬ëŒ ëª©ë¡ -->
        <div class="exp-box" id="people">
        {% if auctions %}
        <h4 style="font-weight: 600;"> ê²½ë§¤ ì°¸ì—¬ ì¤‘ğŸš©</h4>
        {% else %}
        <h4 style="font-weight: 600; color:grey;"> í˜„ì¬ ê²½ë§¤ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</h4>
        {% endif %}
            {% for lt in auctions  %}
            <!-- ì œì‹œí•œ ì‚¬ëŒ -->
            <div class="exp-content info_box">
                <div class="exp-text">
                    <div>
                        <div class="bx">
                            <span>ì œì‹œì</span> <span class="margin-lf">{{lt.buyer}}</span>
                        </div>
                        <div class="bx">
                            <span>ì œì‹œì¼</span> <span class="margin-lf">{{lt.date}}</span>
                        </div>
                        <div class="bx">
                            <span style="color:black;"> {{lt.des}} </span>
                        </div>
                    </div>
                    <div>
                        <label name="maxval" class="right">ì œì‹œê°€</label>
                        <div class="right price"><p style="color:#0f9ea8; font-weight:900; font-size: 20px;">{{lt.offerprice|intcomma}}</p></div>
                    </div>

                </div>
            </div>
            <!-- ì œì‹œí•œ ì‚¬ëŒ ë -->
            {% endfor %}
        </div>
            
    </div>





{% endblock %}

<!-- footer -->

{% block extra_script %} 
<script>
    //ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    var sel_file;
 
    $(document).ready(function() {
        $("#img").on("change", handleImgFileSelect);
    });
 
    function handleImgFileSelect(e) {
        
        const box = document.querySelector(".info_box");
        box.style.maxWidth = "500px";
        
        const imgbox = document.getElementById('img_wrap');
        imgbox.style.maxWidth = "500px";
        imgbox.style.display = "flex";
        
        var files = e.target.files;
        var filesArr = Array.prototype.slice.call(files);
 
        var reg = /(.*?)\/(jpg|jpeg|png|bmp)$/;
 
        filesArr.forEach(function(f) {
            if (!f.type.match(reg)) {
                alert("í™•ì¥ìëŠ” ì´ë¯¸ì§€ í™•ì¥ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
 
            sel_file = f;
 
            var reader = new FileReader();
            reader.onload = function(e) {
                $("#imgon").attr("src", e.target.result);
            }
            reader.readAsDataURL(f);
        });
    }
</script>

<script>
    function goprice(obj) {
      if (!obj.maxval.value) {
        alert("ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return false;
      }  
        
        
      var formData = new FormData();
      formData.append('maxval', obj.maxval.value);
      formData.append('offeruserid', obj.offeruserid.value);
      formData.append('sid', obj.sid.value);
      formData.append('des', obj.des.value);
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

      $.ajax({
        type: 'PUT',
        url: 'https://g-oss-jeoyo-qrxlf.run.goorm.site/api/Service/',
        data: formData,
        processData: false,
        contentType: false,
        success: function (ajax_data) {
            //í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™í•˜ë„ë¡ ë³€ê²½
            alert("ê°€ê²© ì œì‹œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.href = '/proser/detail?sid={{sid}}';
        },
        error: function (xhr) {
            // alert(status, error); 
            switch(xhr.status) {
              case 404 :
                alert("í˜„ì¬ ìµœê³  ê¸ˆì•¡ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡ì„ ì œì‹œí•´ì£¼ì„¸ìš”.");
                break;
              case 405 :
                alert("ë³´ìœ í•œ í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                break;
            }
        }
      });
      return false;
    }
    


    $(document).ready(function() {
        //íŒì—…
        // íŒì—… ì—´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
        $('#price-btn').click(function() {
            $('#popup').fadeIn(); // íŒì—…ì„ í‘œì‹œ
        });

        // íŒì—… ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
        $('.close-btn').click(function() {
            $('#popup').fadeOut(); // íŒì—…ì„ ìˆ¨ê¹€
        });

        // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
        $(window).click(function(event) {
            if ($(event.target).is('#popup')) {
                $('#popup').fadeOut(); // íŒì—…ì„ ìˆ¨ê¹€
            }
        });



        //í¬ë ˆë”§ ì‚¬ìš©
        $('#use-credit').click(function() {
            if (confirm("í¬ë ˆë”§ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nğŸª™500 í¬ë ˆë”§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.")) {
                $.ajax({
                    type: 'GET',
                    url: 'https://g-oss-jeoyo-qrxlf.run.goorm.site/api/UsecreditAPI?uid={{uid}}&sid={{sid}}', // ì—¬ê¸°ì„œ ì ì ˆí•œ URLë¡œ ëŒ€ì²´
                    success: function(data) {
                        alert("ğŸª™500 í¬ë ˆë”§ì´ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.location.href = '/proser/list?op={{op}}';
                    },
                    error: function (xhr) {
                        // alert(status, error); 
                        switch(xhr.status) {
                          case 404 :
                            alert("í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                            break;
                        }
                    }
                });
            }
        });


        //ë‚™ì°°
        $('#finish').click(function() {
            if (confirm("ì •ë§ë¡œ ì…ì°°ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                $.ajax({
                    type: 'GET',
                    url: 'https://g-oss-jeoyo-qrxlf.run.goorm.site/api/ServiceEndAPI?sid={{ sid }}', // ì—¬ê¸°ì„œ ì ì ˆí•œ URLë¡œ ëŒ€ì²´
                    success: function(data) {
                        alert("ë‚™ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        window.location.href = '/proser/list?op={{op}}';
                    },
                    error: function(xhr, status, error) {
                        alert("ë‚™ì°° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        });

        $('#nofinish').click(function() {
            alert("í˜„ì¬ ê²½ë§¤ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.");
        });

        $('#gologin').click(function() {
            if (alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.")) {
                window.location.href = '/login';;
            }
        });


    });

</script>

{% endblock %}